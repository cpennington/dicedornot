"use strict";function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}google.load("visualization","1.0",{packages:["corechart"]}),google.setOnLoadCallback(enableFileInput);function enableFileInput(){$("#file-input-button").removeClass("disabled")}var fileInput=document.getElementById("file-input");fileInput.addEventListener("change",(function(){0<fileInput.files.length&&($("#loading").show(),$("#data-param-error").hide(),$("#summary-div").hide(),$("#results-div").hide(),$("#explanation-div").hide(),io.xmlToJson(fileInput.files[0],(function(a){var b=replay.processReplay(a);renderReplayData(b,"")}),(function(a){$("#loading").hide(),alert(a)})))}));function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1])}var dataParam=getParameterByName("data");dataParam&&($("#loading").show(),$("#data-param-error").hide(),google.setOnLoadCallback(renderDataParam));function renderDataParam(){try{var a=LZString.decompressFromEncodedURIComponent(dataParam),b=JSONC.decompress(JSON.parse(a));renderReplayData(b,dataParam)}catch(a){$("#loading").hide(),$("#data-param-error").show(),console.error(a)}}function renderReplayData(a,b){var c="http://dicedornot.vengefulpickle.com"+"/index.html"+"?data="+b,d=encodeURIComponent(c);updateChart(a.rolls),updateGameDetails(a.gameDetails),$("#loading").hide(),$("#summary-div").show(),$("#results-div").show(),$("#explanation-div").show(),$("#share-massive-url").attr("href",c),$("#share-tiny-url").attr("href","http://tinyurl.com/create.php?url="+d+"#success"),$("#share-alert").show(),$(".other-stats").remove(),document.getElementById("results-with-padding").scrollIntoView()}function updateChart(a){console.log(a);var b=_toConsumableArray(new Set(a.map((function(a){return a.team}))));console.log(b);var c=[];c=c.concat(a.map((function(a){return a.actual})));var d={$schema:"https://vega.github.io/schema/vega-lite/v4.json",width:1e3,height:300,data:{name:"rolls",values:c},transform:[{calculate:"datum.outcomeValue - datum.expectedValue",as:"netValue"},{window:[{op:"sum",field:"netValue",as:"cumNetValue"}],groupby:["team","iteration"]}],layer:[{transform:[{quantile:"cumNetValue",probs:[.01,.1,.25,.5,.75,.9,.99],groupby:["team","index"]},{calculate:"datum.prob * 100",as:"perc"}],mark:{type:"line",opacity:.3,interpolate:"basis"},encoding:{x:{type:"ordinal",field:"index"},y:{field:"value",type:"quantitative"},color:{field:"team",type:"nominal"},detail:{field:"prob",type:"nominal"},tooltip:[{field:"team",title:"Team"},{field:"value",title:"Cumulative Net Value",format:".2f"},{field:"perc",title:"Percentile",format:".0f"}]}},{transform:[{filter:"datum.type == 'actual'"}],mark:{type:"line",interpolate:"monotone"},encoding:{x:{type:"ordinal",field:"index"},y:{field:"cumNetValue",type:"quantitative"},color:{field:"team",type:"nominal"},detail:{field:"iteration",type:"nominal"}}},{transform:[{filter:"datum.type == 'actual'"}],mark:{type:"point"},encoding:{x:{type:"ordinal",field:"index"},y:{field:"cumNetValue",type:"quantitative"},color:{field:"team",type:"nominal"},tooltip:[{field:"team",title:"Team"},{field:"player",title:"Player"},{field:"rollName",title:"Roll"},{field:"outcomeValue",title:"Value",format:".2f"},{field:"expectedValue",title:"Expected Value",format:".2f"},{field:"netValue",title:"Net Value",format:".2f"},{field:"cumNetValue",title:"Cumulative Net Value",format:".2f"}]}}]};vegaEmbed("#chart",d).then((function(b){function c(){for(var e=[],f=Math.max(d,1),g=0;g<f;g++)d++,e=e.concat(a.map((function(a){return a.simulated(d)})));var h=vega.changeset().insert(e);b.view.change("rolls",h).run(),$("#game-count").text(d),1e3>d&&window.setTimeout(c,100)}var d=0;c()}))}function raceIdToName(a){return 1===a?"Human":2===a?"Dwarf":3===a?"Skaven":4===a?"Orc":5===a?"Lizardman":7===a?"Wood Elf":8===a?"Chaos":9===a?"Dark Elf":10===a?"Undead":15===a?"High Elf":21===a?"Chaos Dwarf":22===a?"Underworld":24===a?"Bretonnian":25===a?"Kislev":a}function updateGameDetails(a){$("#file-name").text(a.fileName),$("#home-coach").text(a.homeTeam.coachName),$("#home-team").text(a.homeTeam.teamName),$("#home-race").text(raceIdToName(a.homeTeam.raceId)),$("#home-score").text(a.homeTeam.score),$("#away-coach").text(a.awayTeam.coachName),$("#away-team").text(a.awayTeam.teamName),$("#away-race").text(raceIdToName(a.awayTeam.raceId)),$("#away-score").text(a.awayTeam.score),$("#stadium-name").text(a.stadiumName)}