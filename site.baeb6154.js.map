{"mappings":"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","sources":["./src/js/replay.js","./src/js/site.js"],"sourcesContent":["/* Minifier: http://jscompress.com/ */\n\nimport { Roll } from \"./rolls\";\n\nexport const replay = {\n  processReplay: function (data) {\n    //console.log(\"replay.processReplay\");\n    //console.log(data);\n\n    var gameDetails = extractGameDetails(data);\n    console.log(\"Extracted game details...\", gameDetails);\n\n    var playerDetails = {};\n    var rolls = [];\n    for (\n      var stepIndex = 0;\n      stepIndex < data.replay.replaystep.length;\n      stepIndex++\n    ) {\n      var replayStep = data.replay.replaystep[stepIndex];\n      // extractPlayerDetails(replayStep, playerDetails);\n      //extractActionsFromStep(replayStep, rolls);\n      rolls = rolls.concat(Roll.fromReplayStep(stepIndex, replayStep));\n    }\n    console.log(\"Extracted rolls...\", rolls);\n\n    return {\n      gameDetails: gameDetails,\n      playerDetails: playerDetails,\n      rolls: rolls,\n      version: 1,\n    };\n  },\n};\n\nfunction extractGameDetails(jsonObject) {\n  var firstStep = jsonObject.replay.replaystep[0];\n  var lastStep =\n    jsonObject.replay.replaystep[jsonObject.replay.replaystep.length - 1];\n\n  return {\n    //fileName: lastStep.ruleseventgamefinished.matchresult.row.replayfilename,\n    stadiumName: firstStep.gameinfos.namestadium,\n    //stadiumType: firstStep.gameinfos.stadium,\n    homeTeam: {\n      coachName: firstStep.gameinfos.coachesinfos.coachinfos[0].userid,\n      teamName: firstStep.boardstate.listteams.teamstate[0].data.name,\n      raceId: firstStep.boardstate.listteams.teamstate[0].data.idrace,\n      score: lastStep.ruleseventgamefinished.matchresult.row.homescore || 0,\n    },\n    awayTeam: {\n      coachName: firstStep.gameinfos.coachesinfos.coachinfos[1].userid,\n      teamName: firstStep.boardstate.listteams.teamstate[1].data.name,\n      raceId: firstStep.boardstate.listteams.teamstate[1].data.idrace,\n      score: lastStep.ruleseventgamefinished.matchresult.row.awayscore || 0,\n    },\n  };\n}\n\nfunction translateStringNumberList(str) {\n  if (!str) return [];\n\n  var stripped = str.substring(1, str.length - 1);\n  var textList = stripped.split(\",\");\n\n  var numberList = [];\n  for (var i = 0; i < textList.length; i++) {\n    numberList.push(parseInt(textList[i]));\n  }\n  return numberList;\n}\n\nfunction extractPlayerDetails(replayStep, playerDetails) {\n  var teamStates = (((replayStep || {}).boardstate || {}).listteams || {})\n    .teamstate;\n  if (!teamStates || teamStates.length < 2) return;\n\n  extractPlayerDetailsFromTeamState(teamStates[0], playerDetails);\n  extractPlayerDetailsFromTeamState(teamStates[1], playerDetails);\n}\n\nfunction extractPlayerDetailsFromTeamState(teamState, playerDetails) {\n  var players = ((teamState || {}).listpitchplayers || {}).playerstate;\n  if (!players) return;\n\n  for (var i = 0; i < players.length; i++) {\n    var player = players[i];\n    if (!(player.id in playerDetails)) {\n      playerDetails[player.id] = {\n        id: player.id,\n        teamId: player.data.teamid || 0,\n        type: player.data.idplayertypes,\n        name: player.data.name,\n        // player.data.name is sometimes useful but not populated for hired players\n      };\n    }\n  }\n}\n\nfunction extractActionsFromStep(replayStep, actionsList) {\n  var kickoffDetails = extractKickoffDetails(replayStep);\n  if (kickoffDetails) {\n    actionsList.push(kickoffDetails);\n  }\n\n  var actions = replayStep.ruleseventboardaction;\n  if (actions && actions.length) {\n    for (var actionIndex = 0; actionIndex < actions.length; actionIndex++) {\n      var action = actions[actionIndex];\n      processAction(replayStep, action, actionsList);\n    }\n  } else if (actions) {\n    processAction(replayStep, actions, actionsList);\n  }\n}\n\nfunction processAction(replayStep, action, actionsList) {\n  if (!action) return;\n\n  var results = action.results.boardactionresult;\n  if (results && results.length) {\n    for (var resultIndex = 0; resultIndex < results.length; resultIndex++) {\n      var result = results[resultIndex];\n      processResult(replayStep, action, result, actionsList);\n    }\n  } else {\n    processResult(replayStep, action, results, actionsList);\n  }\n}\n\nfunction processResult(replayStep, action, result, actionsList) {\n  if (!result) return;\n\n  if (result.coachchoices && result.coachchoices.listdices) {\n    var actionDetails = extractActionDetails(replayStep, action, result);\n\n    if (actionDetails) {\n      actionsList.push(actionDetails);\n    }\n  }\n}\n\nfunction extractActionDetails(replayStep, action, result) {\n  if (ignoreResult(result)) {\n    return null;\n  }\n  console.log(action);\n  var dice = translateDice(result.coachchoices.listdices, result.rolltype);\n\n  // Translate kickoff scatters to their own type\n  if (result.rolltype == 10 && dice.length > 1) {\n    result.rolltype = -2;\n  }\n\n  return {\n    team: replayStep.boardstate.activeteam || 0,\n    turn:\n      replayStep.boardstate.listteams.teamstate[\n        replayStep.boardstate.activeteam || 0\n      ].gameturn || 0,\n    player: action.playerid,\n    rollType: result.rolltype,\n    dice: dice,\n    outcomeValue: outcomeValue(\n      result.rolltype,\n      dice,\n      action.playerid,\n      action.targetid\n    ),\n    expectedValue: expectedValue(\n      result.rolltype,\n      dice,\n      action.playerid,\n      action.targetid\n    ),\n  };\n}\n\nfunction expectedValue(rollType, rollResult, player, target) {\n  if (rollType == ROLL_BLOCK) {\n    if (rollResult.length == 1) {\n      values = BLOCK.values.map(blockResultValue);\n    } else {\n      values = TWO_DIE_BLOCK.values.map((dice) =>\n        Math.max(blockResultValue(dice[0]), blockResultValue(dice[1]))\n      );\n    }\n    return values.reduce((a, b) => a + b, 0) / values.length;\n  }\n  return 0;\n}\n\nfunction outcomeValue(rollType, rollResult, player, target) {\n  if (rollType == ROLL_BLOCK) {\n    if (rollResult.length == 1) {\n      return blockResultValue(asBlockDie(rollResult));\n    } else {\n      return Math.max(...rollResult.map(asBlockDie).map(blockResultValue));\n    }\n  }\n  return 0;\n}\n\nfunction ignoreResult(result) {\n  // As far as I can tell, this comes up when a reroll was possible but not used\n  if (result.rollstatus == 2) {\n    return true;\n  }\n\n  // This is the foul penalty - the roll is already covered by an armour roll\n  if (result.rolltype == 15) {\n    return true;\n  }\n\n  // This is some sort of wrestle roll which doesn't do anything\n  if (result.rolltype == 61) {\n    return true;\n  }\n\n  // Some sort of piling-on roll that isn't the armor or the injury roll\n  if (result.rolltype == 63) {\n    return true;\n  }\n\n  // Block dice have dice repeated for the coaches selection, resulttype is missing for the second one\n  if (result.rolltype == 5 && result.resulttype != 2) {\n    return true;\n  }\n\n  // Just guessing at this\n  if (\n    result.rolltype == 8 &&\n    result.resulttype != 2 &&\n    result.subresulttype != 1\n  ) {\n    // Replay Coach-551-9619f4910217db1915282ea2242c819f_2016-04-07_00_05_06, Furry Bears turn 8 crowdsurf injury, shouldn't be ignored\n    if (result.subresulttype != 12) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nfunction translateDice(dice, rollType) {\n  var diceList = translateStringNumberList(dice);\n\n  // For some reason block dice have an extra set of dice at the end\n  if (rollType == 5) {\n    diceList = diceList.slice(0, diceList.length / 2);\n  }\n  // Casualty dice are also doubled up, and also both rolls appear when an apoc is used (so the last one is the valid one)\n  else if (rollType == 8) {\n    diceList = diceList.slice(0, diceList.length / 2);\n    diceList = [diceList[diceList.length - 1]];\n  }\n\n  return diceList;\n}\n\nfunction extractKickoffDetails(replayStep) {\n  if (!replayStep.ruleseventkickofftable) return null;\n\n  return {\n    team: replayStep.boardstate.activeteam || 0,\n    turn:\n      replayStep.boardstate.listteams.teamstate[\n        replayStep.boardstate.activeteam || 0\n      ].gameturn || 0,\n    player: null,\n    rollType: -1,\n    dice: translateDice(replayStep.ruleseventkickofftable.listdice, -1),\n  };\n}\n","/* Minifier: http://jscompress.com/ */\nimport { ROLL_TYPES } from \"./rolls\";\nimport { io } from \"./io\";\nimport { replay } from \"./replay\";\n\ngoogle.load(\"visualization\", \"1.0\", { packages: [\"corechart\"] });\ngoogle.setOnLoadCallback(enableFileInput);\n\nfunction enableFileInput() {\n  $(\"#file-input-button\").removeClass(\"disabled\");\n}\n\nvar fileInput = document.getElementById(\"file-input\");\nfileInput.addEventListener(\"change\", function () {\n  if (fileInput.files.length > 0) {\n    $(\"#loading\").show();\n    $(\"#data-param-error\").hide();\n    $(\"#summary-div\").hide();\n    $(\"#results-div\").hide();\n    $(\"#explanation-div\").hide();\n    console.log(\"Preparing to parse XML...\");\n\n    io.xmlToJson(\n      fileInput.files[0],\n      function (jsonObj) {\n        console.log(\"Preparing to process replay json...\");\n        var replayData = replay.processReplay(jsonObj);\n\n        // var jsoncCompressedJson = JSONC.compress(replayData);\n        // var jsoncCompressedString = JSON.stringify(jsoncCompressedJson);\n        // var lzstringCompressed = LZString.compressToEncodedURIComponent(\n        // jsoncCompressedString\n        // );\n        console.log(\"Preparing to render replay data...\");\n        renderReplayData(replayData, \"\");\n      },\n      function (err) {\n        $(\"#loading\").hide();\n        alert(err);\n      }\n    );\n  }\n});\n\nfunction getParameterByName(name) {\n  name = name.replace(/[\\[]/, \"\\\\[\").replace(/[\\]]/, \"\\\\]\");\n  var regex = new RegExp(\"[\\\\?&]\" + name + \"=([^&#]*)\"),\n    results = regex.exec(location.search);\n  return results === null ? \"\" : decodeURIComponent(results[1]);\n}\n\nvar dataParam = getParameterByName(\"data\");\nif (dataParam) {\n  $(\"#loading\").show();\n  $(\"#data-param-error\").hide();\n  google.setOnLoadCallback(renderDataParam);\n}\n\nfunction renderDataParam() {\n  try {\n    var decompressedString = LZString.decompressFromEncodedURIComponent(\n      dataParam\n    );\n    var replayData = JSONC.decompress(JSON.parse(decompressedString));\n    renderReplayData(replayData, dataParam);\n  } catch (err) {\n    $(\"#loading\").hide();\n    $(\"#data-param-error\").show();\n    console.error(err);\n  }\n}\n\nfunction renderReplayData(replayData, dataParam) {\n  //var baseUrl = \"http://localhost:8080\";\n  var baseUrl = \"http://dicedornot.vengefulpickle.com\";\n  var resultsPage = \"/index.html\";\n  var resultsUrl = baseUrl + resultsPage + \"?data=\" + dataParam;\n  var encodedResultsUrl = encodeURIComponent(resultsUrl);\n  var tinyUrlCreator =\n    \"http://tinyurl.com/create.php?url=\" + encodedResultsUrl + \"#success\";\n\n  console.log(\"Rendering replay data...\");\n  updateChart(replayData.rolls);\n\n  updateGameDetails(replayData.gameDetails);\n\n  $(\"#loading\").hide();\n  $(\"#summary-div\").show();\n  $(\"#results-div\").show();\n  $(\"#explanation-div\").show();\n\n  $(\"#share-massive-url\").attr(\"href\", resultsUrl);\n  $(\"#share-tiny-url\").attr(\"href\", tinyUrlCreator);\n  $(\"#share-alert\").show();\n\n  //console.log(\"Deleting other stats \" + $(\".other-stats\").length);\n  $(\".other-stats\").remove();\n\n  // drawCharts(gameStats, replayData.gameDetails);\n\n  document.getElementById(\"results-with-padding\").scrollIntoView();\n}\n\nfunction updateChart(rolls) {\n  console.log(rolls);\n  var teams = [...new Set(rolls.map((roll) => roll.team))];\n  console.log(teams);\n  var values = [];\n  // for (const team of teams) {\n  //   values.push({ expectedValue: 0, outcomeValue: 0, team: team, index: 0 });\n  // }\n  values = values.concat(rolls.map((roll) => roll.actual));\n  // Assign the specification to a local variable vlSpec.\n  // TODO: put details of the action into the popup\n  var vlSpec = {\n    $schema: \"https://vega.github.io/schema/vega-lite/v4.json\",\n    width: 1000,\n    height: 300,\n    data: {\n      name: \"rolls\",\n      values: values,\n    },\n    transform: [\n      { calculate: \"datum.outcomeValue - datum.expectedValue\", as: \"netValue\" },\n      {\n        window: [{ op: \"sum\", field: \"netValue\", as: \"cumNetValue\" }],\n        groupby: [\"team\", \"iteration\"],\n      },\n    ],\n    // facet: { rows: \"team\" },\n    // spec: {\n    layer: [\n      {\n        transform: [\n          {\n            quantile: \"cumNetValue\",\n            probs: [0.01, 0.1, 0.25, 0.5, 0.75, 0.9, 0.99],\n            groupby: [\"team\", \"index\"],\n          },\n          {\n            calculate: \"datum.prob * 100\",\n            as: \"perc\",\n          },\n        ],\n        mark: {\n          type: \"line\",\n          opacity: 0.3,\n          interpolate: \"basis\",\n        },\n        encoding: {\n          x: {\n            type: \"ordinal\",\n            field: \"index\",\n          },\n          y: {\n            field: \"value\",\n            type: \"quantitative\",\n          },\n          color: {\n            field: \"team\",\n            type: \"nominal\",\n          },\n          detail: {\n            field: \"prob\",\n            type: \"nominal\",\n          },\n          tooltip: [\n            { field: \"team\", title: \"Team\" },\n            { field: \"value\", title: \"Cumulative Net Value\", format: \".2f\" },\n            { field: \"perc\", title: \"Percentile\", format: \".0f\" },\n          ],\n        },\n      },\n      {\n        transform: [\n          {\n            filter: \"datum.type == 'actual'\",\n          },\n        ],\n        mark: { type: \"line\", interpolate: \"monotone\" },\n        encoding: {\n          x: {\n            type: \"ordinal\",\n            field: \"index\",\n          },\n          y: {\n            field: \"cumNetValue\",\n            type: \"quantitative\",\n          },\n          color: {\n            field: \"team\",\n            type: \"nominal\",\n          },\n          detail: {\n            field: \"iteration\",\n            type: \"nominal\",\n          },\n        },\n      },\n      {\n        transform: [\n          {\n            filter: \"datum.type == 'actual'\",\n          },\n        ],\n        mark: { type: \"point\" },\n        encoding: {\n          x: {\n            type: \"ordinal\",\n            field: \"index\",\n          },\n          y: {\n            field: \"cumNetValue\",\n            type: \"quantitative\",\n          },\n          color: {\n            field: \"team\",\n            type: \"nominal\",\n          },\n          tooltip: [\n            { field: \"team\", title: \"Team\" },\n            { field: \"player\", title: \"Player\" },\n            { field: \"playerSkills\", title: \"Player Skill\" },\n            { field: \"rollName\", title: \"Roll\" },\n            { field: \"dice\", title: \"Dice\" },\n            { field: \"target\", title: \"Target\" },\n            { field: \"outcomeValue\", title: \"Value\", format: \".2f\" },\n            { field: \"expectedValue\", title: \"Expected Value\", format: \".2f\" },\n            { field: \"netValue\", title: \"Net Value\", format: \".2f\" },\n            {\n              field: \"cumNetValue\",\n              title: \"Cumulative Net Value\",\n              format: \".2f\",\n            },\n          ],\n        },\n      },\n    ],\n    // }\n  };\n\n  // Embed the visualization in the container with id `vis`\n  vegaEmbed(\"#chart\", vlSpec).then((res) => {\n    var iteration = 0;\n    function addValues() {\n      var values = [];\n      var curIteration = Math.max(iteration, 1);\n      for (var x = 0; x < curIteration; x++) {\n        iteration++;\n        values = values.concat(rolls.map((roll) => roll.simulated(iteration)));\n      }\n      var changeSet = vega.changeset().insert(values);\n      res.view.change(\"rolls\", changeSet).run();\n      $(\"#game-count\").text(iteration);\n      if (iteration < 1000) {\n        window.setTimeout(addValues, 100);\n      }\n    }\n    addValues();\n  });\n}\n\nfunction renderValueTable() {\n  var rollValues = Object.values(ROLL_TYPES)\n    .filter(c => !!c)\n    .map(c => c.valueTable())\n    .flatMap(Object.entries);\n\n  for (var [roll, value] of rollValues) {\n    $(\"#value-table tbody\").append(\n      `<tr scope=\"row\"><td>${roll}</td><td>${value}</td></tr>`\n    );\n  }\n  $(\"#value-table\")\n    .show()\n    .DataTable();\n}\n\nfunction raceIdToName(raceId) {\n  switch (raceId) {\n    case 1:\n      return \"Human\";\n    case 2:\n      return \"Dwarf\";\n    case 3:\n      return \"Skaven\";\n    case 4:\n      return \"Orc\";\n    case 5:\n      return \"Lizardman\";\n    case 6:\n      return \"Goblin\";\n    case 7:\n      return \"Wood Elf\";\n    case 8:\n      return \"Chaos\";\n    case 9:\n      return \"Dark Elf\";\n    case 10:\n      return \"Undead\";\n    case 14:\n      return \"Pro Elf\";\n    case 15:\n      return \"High Elf\";\n    case 17:\n      return \"Necromantic\";\n    case 21:\n      return \"Chaos Dwarf\";\n    case 22:\n      return \"Underworld\";\n    case 24:\n      return \"Bretonnian\";\n    case 25:\n      return \"Kislev\";\n    default:\n      return raceId;\n  }\n}\n\nfunction updateGameDetails(gameDetails) {\n  $(\"#file-name\").text(gameDetails.fileName);\n\n  $(\"#home-coach\").text(gameDetails.homeTeam.coachName);\n  $(\"#home-team\").text(gameDetails.homeTeam.teamName);\n  $(\"#home-race\").text(raceIdToName(gameDetails.homeTeam.raceId));\n  $(\"#home-score\").text(gameDetails.homeTeam.score);\n\n  $(\"#away-coach\").text(gameDetails.awayTeam.coachName);\n  $(\"#away-team\").text(gameDetails.awayTeam.teamName);\n  $(\"#away-race\").text(raceIdToName(gameDetails.awayTeam.raceId));\n  $(\"#away-score\").text(gameDetails.awayTeam.score);\n\n  $(\"#stadium-name\").text(gameDetails.stadiumName);\n}\n"],"names":["$e5af0825b45788cf008f1731d77$var$_rolls","$de1762abb55249d07ce983$init","processReplay","data","gameDetails","jsonObject","firstStep","replay","replaystep","lastStep","length","stadiumName","gameinfos","namestadium","homeTeam","coachName","coachesinfos","coachinfos","userid","teamName","boardstate","listteams","teamstate","name","raceId","idrace","score","ruleseventgamefinished","matchresult","row","homescore","awayTeam","awayscore","extractGameDetails","console","log","replayStep","rolls","stepIndex","concat","Roll","fromReplayStep","playerDetails","version","google","load","packages","setOnLoadCallback","$","removeClass","fileInput","document","getElementById","addEventListener","files","show","hide","io","xmlToJson","jsonObj","replayData","renderReplayData","err","alert","dataParam","replace","results","RegExp","exec","location","search","decodeURIComponent","getParameterByName","resultsUrl","encodedResultsUrl","encodeURIComponent","teams","$bd9ae5e99ecff46d330698ba8f180cc8$var$_toConsumableArray","Set","map","roll","team","values","actual","vegaEmbed","$schema","width","height","transform","calculate","as","window","op","field","groupby","layer","quantile","probs","mark","type","opacity","interpolate","encoding","x","y","color","detail","tooltip","title","format","filter","then","res","iteration","addValues","curIteration","Math","max","simulated","changeSet","vega","changeset","insert","view","change","run","text","setTimeout","updateChart","fileName","raceIdToName","updateGameDetails","attr","remove","scrollIntoView","decompressedString","LZString","decompressFromEncodedURIComponent","JSONC","decompress","JSON","parse","error"],"version":3,"file":"site.baeb6154.js.map"}